# Deny access to database directory
<Files ~ "\.sqlite$">
Order allow,deny
Deny from all
</Files>

# Deny access to the schema.sql file
<Files ~ "schema\.sql$">
Order allow,deny
Deny from all
</Files>

# Protect database directory
<IfModule mod_rewrite.c>
    RewriteEngine On
    RewriteRule ^database/ - [F,L]
</IfModule>

# Prevent directory listing
Options -Indexes

# Set default character set
AddDefaultCharset UTF-8

# Protect against XSS attacks and set security policy
<IfModule mod_headers.c>
    Header set X-XSS-Protection "1; mode=block"
    Header set X-Content-Type-Options "nosniff"
    Header set X-Frame-Options "SAMEORIGIN"
    Header set Referrer-Policy "strict-origin-when-cross-origin"
    
    # Content Security Policy
    Header set Content-Security-Policy "default-src 'self'; \
        script-src 'self' 'unsafe-inline' 'unsafe-eval' \
            https://cdnjs.cloudflare.com \
            https://s3-us-west-2.amazonaws.com \
            https://www.paypal.com \
            https://*.paypal.com \
            https://www.sandbox.paypal.com \
            https://*.paypalobjects.com \
            https://js.stripe.com \
            https://*.stripe.com \
            https://sandbox.web.squarecdn.com \
            https://web.squarecdn.com \
            https://*.squarecdn.com \
            https://*.squareup.com; \
        style-src 'self' 'unsafe-inline' \
            https://fonts.googleapis.com \
            https://cdnjs.cloudflare.com \
            https://*.paypalobjects.com \
            https://*.stripe.com \
            https://*.squarecdn.com \
            https://*.squareup.com; \
        font-src 'self' \
            https://fonts.gstatic.com \
            https://cdnjs.cloudflare.com \
            https://*.paypalobjects.com \
            https://*.stripe.com \
            https://*.squarecdn.com; \
        img-src 'self' data: \
            https://s3-us-west-2.amazonaws.com \
            https://chart.googleapis.com \
            https://*.paypalobjects.com \
            https://*.paypal.com \
            https://*.stripe.com \
            https://*.squarecdn.com \
            https://*.squareup.com; \
        frame-src \
            https://www.youtube.com \
            https://www.youtube-nocookie.com \
            https://www.paypal.com \
            https://*.paypal.com \
            https://www.sandbox.paypal.com \
            https://*.sandbox.paypal.com \
            https://js.stripe.com \
            https://*.stripe.com \
            https://*.squarecdn.com \
            https://*.squareup.com; \
        connect-src 'self' \
            https://formspree.io \
            https://www.paypal.com \
            https://*.paypal.com \
            https://www.sandbox.paypal.com \
            https://*.sandbox.paypal.com \
            https://*.paypalobjects.com \
            https://api.stripe.com \
            https://*.stripe.com \
            https://checkout.stripe.com \
            https://connect.squareup.com \
            https://*.squareup.com \
            https://api.squareup.com \
            https://*.squarecdn.com \
            https://sandbox.web.squarecdn.com \
            https://web.squarecdn.com \
            https://pci-connect.squareupsandbox.com \
            https://pci-connect.squareup.com \
            https://*.squareupsandbox.com;"
    
    # Add Cache Control for better performance
    <FilesMatch "\.(html|htm|js|css)$">
        Header set Cache-Control "max-age=3600, must-revalidate"
    </FilesMatch>
    
    <FilesMatch "\.(ico|pdf|jpg|jpeg|png|gif|svg)$">
        Header set Cache-Control "max-age=86400, public"
    </FilesMatch>
    
    # Force download for executable files
    <FilesMatch "\.(exe|msi)$">
        Header set Content-Type "application/octet-stream"
        Header set Content-Disposition "attachment"
    </FilesMatch>
</IfModule>

# Redirect to error pages
ErrorDocument 400 /error-pages/400.html
ErrorDocument 401 /error-pages/401.html
ErrorDocument 403 /error-pages/403.html
ErrorDocument 404 /error-pages/404.html
ErrorDocument 500 /error-pages/500.html
ErrorDocument 503 /error-pages/503.html

# PHP error handling
php_flag display_errors Off
php_flag log_errors On
php_value error_log error_log.txt

# ALL REWRITE RULES IN ONE BLOCK
<IfModule mod_rewrite.c>
    RewriteEngine On
    
    # Protect database directory
    RewriteRule ^database/ - [F,L]
    
    # Download handling rules with filename in URL
    RewriteRule ^download/([^/]+\.exe)$ get_installer.php?filename=$1 [L,QSA]
    RewriteRule ^download/?$ get_installer.php [L,QSA]
    
    # Allow direct access to installer files but track downloads
    RewriteCond %{REQUEST_FILENAME} \.(exe|msi)$ [NC]
    RewriteRule ^resources/downloads/(.+)$ track_and_serve.php?file=$1 [L,QSA]
</IfModule>